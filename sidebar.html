<!DOCTYPE html>
<html>
	<head>
		<base target="_top">
		<style>
			body
			{
				font-family: Arial, sans-serif;
				margin: 20px;
			}
			label
			{
				display: block;
				margin-top: 10px;
			}
			input
			{
				width: 100%;
				padding: 8px;
				margin-top: 5px;
				box-sizing: border-box;
			}
			button
			{
				margin-top: 20px;
				padding: 10px 15px;
				background-color: #4285F4;
				color: white;
				border: none;
				cursor: pointer;
			}
			button:hover
			{
				background-color: #357ae8;
			}
			button:disabled
			{
				background-color: #cccccc;
				cursor: not-allowed;
			}
			.cancel-button-style
			{
				background-color: #dc3545; /* Red color */
			}
			.cancel-button-style:hover:enabled
			{
				background-color: #c82333; /* Darker red on hover for enabled state */
			}
		</style>
	</head>
	<body>
		<h2>Teknocrat</h2>
		<p>Create Google Docs from a template and sheet data.</p>
		
		<label for="template-url">Template Google Doc URL:</label>
		<input type="text" id="template-url">
		
		<label for="data-range">Data Range (e.g., A1:C10):</label>
		<input type="text" id="data-range">

		<label for="output-folder-id">Output Folder ID:</label>
		<input type="text" id="output-folder-id">
		<small>Right-click a folder in Google Drive, select "Get link", and copy the ID from the URL.</small>

		<label for="doc-path">Document Name Template:</label>
		<input type="text" id="doc-path">
		
		<button id="generate-button" onclick="generateDocs()">Generate Docs</button>
		<button id="cancel-button" class="cancel-button-style" onclick="cancelGeneration()">Cancel</button>
		
		<script>
			window.addEventListener('load', function()
			{
				google.script.run.withSuccessHandler(function(props)
				{
					document.getElementById('template-url').value = props['teknocrat.templateUrl'] || '';
					document.getElementById('data-range').value = props['teknocrat.dataRange'] || '';
					document.getElementById('output-folder-id').value = props['teknocrat.outputFolderId'] || '';
					document.getElementById('doc-path').value = props['teknocrat.docPath'] || '';
				}).getUserProperties();

				// Initial state: Cancel button disabled
				document.getElementById('cancel-button').disabled = true;
			});

			function generateDocs()
			{
				const templateUrl = document.getElementById('template-url').value;
				const dataRange = document.getElementById('data-range').value;
				const outputFolderId = document.getElementById('output-folder-id').value;
				const docPath = document.getElementById('doc-path').value;

				const generateButton = document.getElementById('generate-button');
				const cancelButton = document.getElementById('cancel-button');

				generateButton.disabled = true; // Disable generate button
				cancelButton.disabled = false; // Enable cancel button

				const successHandler = function()
				{
					generateButton.disabled = false; // Re-enable generate button
					cancelButton.disabled = true; // Disable cancel button
					// Optionally, show a success message
				};

				const failureHandler = function(error)
				{
					generateButton.disabled = false; // Re-enable generate button
					cancelButton.disabled = true; // Disable cancel button
					alert('Error: ' + error.message); // Show error message
				};

				// Save the values before running the generation
				google.script.run
					.withSuccessHandler(function()
					{
						google.script.run
							.withSuccessHandler(successHandler)
							.withFailureHandler(failureHandler)
							.generateDocuments(templateUrl, dataRange, outputFolderId, docPath);
					})
					.withFailureHandler(failureHandler)
					.saveUserProperties(templateUrl, dataRange, outputFolderId, docPath);
			}

			function cancelGeneration()
			{
				const cancelButton = document.getElementById('cancel-button');
				// Disable cancel button once clicked
				cancelButton.disabled = true;
				alert('Document generation cannot be interrupted once started, but it will complete shortly.');
				// Signal the server to mark for cancellation
				google.script.run.setCancelFlag();
			}
		</script>
	</body>
</html>